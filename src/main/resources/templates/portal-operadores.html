<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Operadores</title>
    <link rel="stylesheet" href="css/portales.css">
</head>
<body>
<header>
    <div class="container">
        <div class="logo">
            <img src="/img/logo.png" alt="Energía Inteligente">
        </div>
        <button onclick="cerrarSesion()">CERRAR SESIÓN</button>
    </div>
</header>

<section class="welcome-section">
    <div class="container">
        <h2>Bienvenido(a) al Portal de Operadores</h2>
        <p id="nombreOperador"></p>
    </div>
</section>

<section>
    <div class="container">
        <div class="menu">
            <ul>
                <li class="active">Menu</li>
                <li>Incidencias</li>
                <li>Alertas</li>
                <li>Mapa</li>
                <li>Facturación</li>
                <li>Clientes</li>
                <li>Empleados</li>
            </ul>
        </div>

        <div class="content-area">
            <div class="empty-message">Seleccione una opción del menú</div>

            <!-- INCIDENCIAS -->
            <div class="content" id="incidencias">
                <h2>Gestión de Incidencias</h2>
                <form id="incidencia-form">
                    <label>ID:</label>
                    <input type="text" class="form-control" placeholder="ID de la incidencia">
                    <label>Tipo:</label>
                    <select class="form-control">
                        <option>Técnica</option>
                        <option>Comercial</option>
                        <option>Seguridad</option>
                    </select>
                    <label>Descripción:</label>
                    <textarea class="form-control" rows="3"></textarea>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>

            <!-- ALERTAS -->
            <div class="content" id="alertas">
                <h2>Gestión de Alertas</h2>
                <p>Contenido de alertas (por implementar).</p>
            </div>

            <!-- MAPA -->
            <div class="content" id="mapa">
                <h2>Mapa de Operaciones</h2>
                <div style="height: 300px; background-color: #eee; text-align: center; padding: 100px;">
                    Mapa interactivo (próximamente)
                </div>
            </div>

            <!-- FACTURACIÓN -->
            <div class="content" id="facturacion">
                <h2>Gestión de Facturación</h2>
                <form id="factura-form">
                    <label>ID:</label>
                    <input type="text" class="form-control" placeholder="ID de la factura">
                    <label>Cliente:</label>
                    <input type="text" class="form-control" placeholder="Nombre del cliente">
                    <label>Periodo:</label>
                    <input type="month" class="form-control">
                    <label>Monto:</label>
                    <input type="number" class="form-control">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
            <!-- CLIENTES -->
            <div class="content" id="clientes">
                <h2>Gestión de Clientes</h2>
                <div class="form-container">
                    <form id="cliente-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Número de identificación:</label>
                                <input type="text" name="id" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Correo:</label>
                                <input type="email" name="correo" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Teléfono:</label>
                                <input type="tel" name="celular" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Número de cuenta:</label>
                                <input type="text" name="numeroCuenta" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Dirección:</label>
                                <input type="text" name="direccion" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3>Clientes Registrados</h3>
                    <div class="search-bar">
                        <input type="text" id="search-cliente" placeholder="Buscar cliente..." class="search-input">
                        <button class="search-btn">Buscar</button>
                    </div>
                    <table id="clientes-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Número de identificación</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Teléfono</th>
                            <th>Cuenta</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Datos se llenarán dinámicamente -->
                        <tr>
                            <td colspan="5">Cargando datos...</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- EMPLEADOS -->
            <div class="content" id="empleados">
                <h2>Gestión de Empleados</h2>
                <div class="form-container">
                    <form id="empleado-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cédula:</label>
                                <input type="text" name="cedula" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" name="usuario" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contraseña:</label>
                                <input type="password" name="contrasena" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Área Encargada:</label>
                                <input type="text" name="areaEncargada" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Empleado</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3>Empleados Registrados</h3>
                    <div class="search-bar">
                        <input type="text" id="search-empleado" placeholder="Buscar empleado..." class="search-input">
                        <button class="search-btn">Buscar</button>
                    </div>
                    <table id="empleados-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Cédula</th>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>Área</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Datos se llenarán dinámicamente -->
                        <tr>
                            <td colspan="5">Cargando datos...</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>&copy; 2025 Energía Inteligente</p>
    </div>
</footer>
<script>
    // Variables globales para el estado
    let clientes = [];
    let empleados = [];
    let modoEdicionCliente = false;
    let clienteEditando = null;
    let modoEdicionEmpleado = false;
    let empleadoEditando = null;

    document.addEventListener('DOMContentLoaded', function() {
        // Configuración del menú
        const menuItems = document.querySelectorAll('.menu ul li');
        const contents = document.querySelectorAll('.content');
        const emptyMessage = document.querySelector('.empty-message');

        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                contents.forEach(c => c.classList.remove('active'));

                if(this.textContent === 'Menu') {
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    const contentId = this.textContent.toLowerCase().replace(/\s+/g, '-').normalize("NFD").replace(/[̀-ͯ]/g, "");
                    const target = document.getElementById(contentId);
                    if (target) target.classList.add('active');

                    // Cargar datos cuando se selecciona la pestaña
                    if (contentId === 'clientes') cargarClientes();
                    if (contentId === 'empleados') cargarEmpleados();
                }
            });
        });

        // Formulario de Cliente
        const clienteForm = document.getElementById('cliente-form');
        clienteForm.addEventListener('submit', manejarCliente);

        // Botón de búsqueda de clientes
        document.querySelector('#clientes .search-btn').addEventListener('click', () => {
            const termino = document.getElementById('search-cliente').value;
            buscarClientes(termino);
        });

        // Formulario de Empleado
        const empleadoForm = document.getElementById('empleado-form');
        empleadoForm.addEventListener('submit', manejarEmpleado);

        // Botón de búsqueda de empleados
        document.querySelector('#empleados .search-btn').addEventListener('click', () => {
            const termino = document.getElementById('search-empleado').value;
            buscarEmpleados(termino);
        });

        // Cargar datos iniciales si estamos en la sección de clientes o empleados
        if (window.location.hash === '#clientes') cargarClientes();
        if (window.location.hash === '#empleados') cargarEmpleados();
    });

    // ==================== FUNCIONES PARA CLIENTES ====================

    async function cargarClientes() {
        try {
            const response = await fetch("http://localhost:8080/api/admin/clientes");
            if (!response.ok) throw new Error("Error al cargar clientes");

            clientes = await response.json();
            renderizarClientes(clientes);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar clientes: " + error.message);
        }
    }

    function renderizarClientes(listaClientes) {
        const tbody = document.querySelector('#clientes-table tbody');
        tbody.innerHTML = '';

        listaClientes.forEach(cliente => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cliente.nombre || ''}</td>
                <td>${cliente.correo || ''}</td>
                <td>${cliente.celular || ''}</td>
                <td>${cliente.numeroCuenta || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${cliente.id}">Editar</button>
                    <button class="btn-delete" data-id="${cliente.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Agregar eventos a los botones
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editarCliente(btn.dataset.id));
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', () => eliminarCliente(btn.dataset.id));
        });
    }

    async function buscarClientes(termino) {
        if (!termino) return cargarClientes();

        const resultados = clientes.filter(cliente =>
            cliente.nombre?.toLowerCase().includes(termino.toLowerCase()) ||
            cliente.correo?.toLowerCase().includes(termino.toLowerCase()) ||
            cliente.numeroCuenta?.includes(termino)
        );

        renderizarClientes(resultados);
    }

    async function editarCliente(id) {
        const cliente = clientes.find(c => c.id === id);
        if (!cliente) return;

        const form = document.getElementById('cliente-form');
        form.nombre.value = cliente.nombre || '';
        form.correo.value = cliente.correo || '';
        form.celular.value = cliente.celular || '';
        form.numeroCuenta.value = cliente.numeroCuenta || '';
        form.direccion.value = cliente.direccion || '';

        modoEdicionCliente = true;
        clienteEditando = cliente;

        // Cambiar el texto del botón
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Cliente';
    }

    async function eliminarCliente(id) {
        if (!confirm('¿Está seguro de eliminar este cliente?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/admin/clientes/${id}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error("Error al eliminar cliente");

            alert("Cliente eliminado correctamente");
            cargarClientes();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar cliente: " + error.message);
        }
    }

    async function manejarCliente(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        try {
            let response;
            const url = modoEdicionCliente
                ? `http://localhost:8080/api/admin/clientes/${clienteEditando.id}`
                : "http://localhost:8080/api/admin/clientes";

            const method = modoEdicionCliente ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar cliente");

            alert(`Cliente ${modoEdicionCliente ? 'actualizado' : 'creado'} correctamente`);
            form.reset();
            modoEdicionCliente = false;
            clienteEditando = null;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Cliente';
            cargarClientes();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar cliente: " + error.message);
        }
    }

    // ==================== FUNCIONES PARA EMPLEADOS ====================

    async function cargarEmpleados() {
        try {
            const response = await fetch("http://localhost:8080/api/admin/empleados");
            if (!response.ok) throw new Error("Error al cargar empleados");

            empleados = await response.json();
            renderizarEmpleados(empleados);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar empleados: " + error.message);
        }
    }

    function renderizarEmpleados(listaEmpleados) {
        const tbody = document.querySelector('#empleados-table tbody');
        tbody.innerHTML = '';

        listaEmpleados.forEach(empleado => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${empleado.cedula || ''}</td>
                <td>${empleado.nombre || ''}</td>
                <td>${empleado.usuario || ''}</td>
                <td>${empleado.areaEncargada || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${empleado.cedula}">Editar</button>
                    <button class="btn-delete" data-id="${empleado.cedula}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Agregar eventos a los botones
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editarEmpleado(btn.dataset.id));
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', () => eliminarEmpleado(btn.dataset.id));
        });
    }

    async function buscarEmpleados(termino) {
        if (!termino) return cargarEmpleados();

        const resultados = empleados.filter(empleado =>
            empleado.nombre?.toLowerCase().includes(termino.toLowerCase()) ||
            empleado.usuario?.toLowerCase().includes(termino.toLowerCase()) ||
            empleado.cedula?.includes(termino)
        );

        renderizarEmpleados(resultados);
    }

    async function editarEmpleado(cedula) {
        const empleado = empleados.find(e => e.cedula === cedula);
        if (!empleado) return;

        const form = document.getElementById('empleado-form');
        form.cedula.value = empleado.cedula || '';
        form.usuario.value = empleado.usuario || '';
        form.nombre.value = empleado.nombre || '';
        form.areaEncargada.value = empleado.areaEncargada || '';
        form.contrasena.placeholder = "Dejar en blanco para no cambiar";

        modoEdicionEmpleado = true;
        empleadoEditando = empleado;

        // Cambiar el texto del botón
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Empleado';
    }

    async function eliminarEmpleado(cedula) {
        if (!confirm('¿Está seguro de eliminar este empleado?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/admin/empleados/${cedula}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error("Error al eliminar empleado");

            alert("Empleado eliminado correctamente");
            cargarEmpleados();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar empleado: " + error.message);
        }
    }

    async function manejarEmpleado(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        try {
            let response;
            const url = modoEdicionEmpleado
                ? `http://localhost:8080/api/admin/empleados/${empleadoEditando.cedula}`
                : "http://localhost:8080/api/admin/empleados";

            const method = modoEdicionEmpleado ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar empleado");

            alert(`Empleado ${modoEdicionEmpleado ? 'actualizado' : 'creado'} correctamente`);
            form.reset();
            modoEdicionEmpleado = false;
            empleadoEditando = null;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Empleado';
            cargarEmpleados();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar empleado: " + error.message);
        }
    }

    function cerrarSesion() {
        window.location.href = "/";
    }
</script>
</body>
</html>
