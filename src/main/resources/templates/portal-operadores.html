<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Operadores</title>
    <link rel="stylesheet" href="css/portales.css">
</head>
<body>
<header>
    <div class="container">
        <div class="logo">
            <img src="/img/logo.png" alt="Energía Inteligente">
        </div>
        <button onclick="cerrarSesion()">CERRAR SESIÓN</button>
    </div>
</header>

<section class="welcome-section">
    <div class="container">
        <h2>Bienvenido(a) al Portal de Operadores</h2>
        <p id="nombreOperador"></p>
    </div>
</section>

<section>
    <div class="container">
        <div class="menu">
            <ul>
                <li class="active">Menu</li>
                <li>Incidencias</li>
                <li>Alertas</li>
                <li>Mapa</li>
                <li>Facturación</li>
                <li>Clientes</li>
                <li>Empleados</li>
            </ul>
        </div>

        <div class="content-area">
            <div class="empty-message">Seleccione una opción del menú</div>

            <div class="content" id="incidencias">
                <h2>Gestión de Incidencias</h2>
                <form id="incidencia-form">
                    <label>ID:</label>
                    <input type="text" class="form-control" placeholder="ID de la incidencia">
                    <label>Tipo:</label>
                    <select class="form-control">
                        <option>Técnica</option>
                        <option>Comercial</option>
                        <option>Seguridad</option>
                    </select>
                    <label>Descripción:</label>
                    <textarea class="form-control" rows="3"></textarea>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>

            <div class="content" id="alertas">
                <h2>Gestión de Alertas</h2>
                <div class="form-container">
                    <form id="alerta-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dispositivo:</label>
                                <input type="text" name="dispositivo" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo:</label>
                                <input type="text" name="tipo" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Severidad:</label>
                                <select name="severidad" class="form-control" required>
                                    <option value="Alta">Alta</option>
                                    <option value="Media">Media</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Descripción:</label>
                                <textarea name="descripcion" class="form-control" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Alerta</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3>Alertas Recientes</h3>
                    <div class="filter-bar">
                        <select id="alert-filter" class="filter-select">
                            <option value="all">Todas</option>
                            <option value="high">Alta Severidad</option>
                            <option value="medium">Media Severidad</option>
                            <option value="low">Baja Severidad</option>
                        </select>
                        <button onclick="filtrarAlertas()">Filtrar</button>
                    </div>
                    <table id="alertas-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Dispositivo</th>
                            <th>Tipo</th>
                            <th>Descripción</th>
                            <th>Severidad</th>
                            <th>Fecha</th>
                        </tr>
                        </thead>
                        <tbody id="alertas-body">
                        </tbody>
                    </table>
                </div>
            </div>


            <div class="content" id="mapa">
                <h2>Gestión de Dispositivos</h2>
                <div class="form-container">
                    <form id="dispositivo-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo:</label>
                                <select name="tipo" class="form-control" required>
                                    <option value="Sensor">Sensor</option>
                                    <option value="Medidor">Medidor</option>
                                    <option value="Controlador">Controlador</option>
                                    <option value="Panel">Panel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estado:</label>
                                <select name="estado" class="form-control" required>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Ubicación:</label>
                                <input type="text" name="ubicacion" id="ubicacion-input" class="form-control" required readonly>
                                <input type="hidden" name="coordenadas" id="coordenadas-input">
                                <small class="text-muted">Haz clic en "Seleccionar en Mapa" para elegir la ubicación</small>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="abrirMapaParaSeleccionar()">Seleccionar en Mapa</button>
                            <button type="submit" class="btn btn-primary">Guardar Dispositivo</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <input type="text" id="buscar-dispositivo" class="search-input" placeholder="Buscar dispositivos...">
                    <button id="btn-buscar-dispositivo" class="btn btn-primary">Buscar</button>
                    <button id="btn-mostrar-todos" class="btn btn-secondary">Mostrar Todos</button>
                </div>

                <div id="resultados-dispositivos" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="dispositivos-body"></tbody>
                    </table>
                </div>
            </div>




            <div class="content" id="facturacion">
                <h2>Gestión de Facturación</h2>
                <form id="factura-form">
                    <label>ID:</label>
                    <input type="text" class="form-control" placeholder="ID de la factura">
                    <label>Cliente:</label>
                    <input type="text" class="form-control" placeholder="Nombre del cliente">
                    <label>Periodo:</label>
                    <input type="month" class="form-control">
                    <label>Monto:</label>
                    <input type="number" class="form-control">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>

            <div class="content" id="clientes">
                <h2>Gestión de Clientes</h2>
                <div class="form-container">
                    <form id="cliente-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Número de identificación:</label>
                                <input type="text" name="id" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Correo:</label>
                                <input type="email" name="correo" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Teléfono:</label>
                                <input type="tel" name="celular" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Número de cuenta:</label>
                                <input type="text" name="numeroCuenta" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Dirección:</label>
                                <input type="text" name="direccion" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>


                <div class="search-container">
                    <input type="text" id="search-cliente" class="search-input" placeholder="Buscar clientes...">
                    <button id="btn-search-cliente" class="btn btn-primary">Buscar</button>
                    <button id="search-btn-clientes" class="btn btn-secondary">Mostrar Todos</button>
                </div>
                <div id="resultados-clientes" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>
                    <table id="clientes-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Número de identificación</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Teléfono</th>
                            <th>Cuenta</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="content" id="empleados">
                <h2>Gestión de Empleados</h2>
                <div class="form-container">
                    <form id="empleado-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cédula:</label>
                                <input type="text" name="cedula" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" name="usuario" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contraseña:</label>
                                <input type="password" name="contrasena" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Cargo:</label>
                                <input type="text" name="areaEncargada" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Empleado</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <input type="text" id="search-empleado" class="search-input" placeholder="Buscar empleados...">
                    <button id="btn-search-empleado" class="btn btn-primary">Buscar</button>
                    <button id="search-btn-empleados" class="btn btn-secondary">Mostrar Todos</button>
                </div>
                <div id="resultados-empleados" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>

                    <table id="empleados-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Cédula</th>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>Área</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>&copy; 2025 Energía Inteligente</p>
    </div>
</footer>
<script>
    // Variables globales para el estado (UNA SOLA VEZ)
    let clientes = [];
    let empleados = [];
    let modoEdicionCliente = false;
    let clienteEditando = null;
    let modoEdicionEmpleado = false;
    let empleadoEditando = null;
    let modoEdicionAlerta = false; // Agregada, asumiendo que la necesitas para alertas
    let alertaEditando = null; // Agregada

    document.addEventListener('DOMContentLoaded', function() {
        // Configuración del menú
        const menuItems = document.querySelectorAll('.menu ul li');
        const contents = document.querySelectorAll('.content');
        const emptyMessage = document.querySelector('.empty-message');

        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                contents.forEach(c => c.classList.remove('active'));

                if(this.textContent === 'Menu') {
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    const contentId = this.textContent.toLowerCase().replace(/\s+/g, '-').normalize("NFD").replace(/[̀-ͯ]/g, "");
                    const target = document.getElementById(contentId);
                    if (target) target.classList.add('active');

                    // --- CAMBIOS CLAVE AQUÍ ---
                    if (contentId === 'clientes') {
                        // Al seleccionar clientes, limpiar el formulario y vaciar la tabla
                        limpiarFormularioCliente();
                        renderizarClientes([]); // Muestra la tabla vacía
                        document.getElementById("resultados-clientes").style.display = "none"; // Ocultar resultados inicialmente
                    } else if (contentId === 'empleados') {
                        limpiarFormularioEmpleado(); // Asumiendo que también quieres limpiar empleados
                        renderizarEmpleados([]); // Muestra la tabla vacía para empleados
                        document.getElementById("resultados-empleados").style.display = "none"; // Ocultar resultados inicialmente
                    } else if (contentId === 'mapa') {
                        // Para Dispositivos, inicializar el formulario y posiblemente no mostrar la tabla
                        limpiarFormularioDispositivo();
                        renderizarDispositivos([]); // Vaciar la tabla de dispositivos
                        document.getElementById("resultados-dispositivos").style.display = "none"; // Ocultar resultados inicialmente
                    } else if (contentId === 'alertas') {
                        limpiarFormularioAlerta(); // Limpiar formulario de alertas
                        renderizarAlertas([]); // Renderizar tabla de alertas vacía
                        // Aquí puedes decidir si quieres que las alertas se carguen automáticamente o no.
                        // Si quieres que se carguen al seleccionar la pestaña, descomenta:
                        // cargarTodasLasAlertas();
                    }
                    // --- FIN CAMBIOS CLAVE ---
                }
            });
        });

        // Configurar Event Listeners de formularios y botones de búsqueda
        document.getElementById('cliente-form').addEventListener('submit', manejarCliente);
        document.getElementById('btn-search-cliente').addEventListener('click', buscarClientesPorAPI); // Nueva función de búsqueda para clientes
        document.getElementById('search-btn-clientes').addEventListener('click', () => { // Botón "Mostrar Todos" para clientes
            document.getElementById('search-cliente').value = ''; // Limpiar el input de búsqueda
            buscarClientesPorAPI(''); // Cargar todos los clientes (simulando búsqueda vacía)
        });

        document.getElementById('empleado-form').addEventListener('submit', manejarEmpleado);
        document.getElementById('btn-search-empleado').addEventListener('click', buscarEmpleadosPorAPI); // Nueva función de búsqueda para empleados
        document.getElementById('search-btn-empleados').addEventListener('click', () => { // Botón "Mostrar Todos" para empleados
            document.getElementById('search-empleado').value = ''; // Limpiar el input de búsqueda
            buscarEmpleadosPorAPI(''); // Cargar todos los empleados (simulando búsqueda vacía)
        });

        document.getElementById('dispositivo-form').addEventListener('submit', manejarDispositivo);
        document.getElementById('btn-buscar-dispositivo').addEventListener('click', () => {
            const termino = document.getElementById('buscar-dispositivo').value.trim();
            buscarDispositivos(termino);
        });
        document.getElementById('btn-mostrar-todos').addEventListener('click', () => {
            document.getElementById('buscar-dispositivo').value = '';
            buscarDispositivos();
        });
        document.getElementById('buscar-dispositivo').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const termino = document.getElementById('buscar-dispositivo').value.trim();
                buscarDispositivos(termino);
            }
        });

        document.getElementById('alerta-form').addEventListener('submit', manejarAlerta);
        // Event listeners para filtros de alertas (asegúrate que los IDs de tus select son correctos)
        // document.getElementById('alert-filter').addEventListener('change', filtrarAlertas); // Si quieres filtrar al cambiar el select
        // document.getElementById('otro-filtro').addEventListener('change', filtrarAlertas); // Si tienes más filtros

        // Escuchar mensajes del mapa (se mantiene igual)
        window.addEventListener('message', function(event) {
            if (event.data.type === 'ubicacionSeleccionada') {
                const form = document.getElementById('dispositivo-form');
                form.ubicacion.value = event.data.direccion;
                form.coordenadas.value = event.data.coordenadas;
            }
        });
    });

    // ==================== FUNCIONES PARA CLIENTES ====================

    // Esta función ahora solo se usa internamente por buscarClientesPorAPI si no hay término
    async function cargarTodosLosClientes() {
        try {
            const response = await fetch("http://localhost:8080/api/admin/clientes");
            if (!response.ok) throw new Error("Error al cargar todos los clientes");

            clientes = await response.json(); // Actualizamos la variable global
            renderizarClientes(clientes); // Renderiza todos los clientes cargados
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar todos los clientes: " + error.message);
        }
    }

    function renderizarClientes(listaClientes) {
        const tbody = document.querySelector('#clientes-table tbody');
        tbody.innerHTML = ''; // Limpia la tabla existente

        if (listaClientes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No se encontraron clientes. Realice una búsqueda.</td></tr>';
            // Mostrar la tabla incluso si está vacía para ver el mensaje
            document.getElementById("resultados-clientes").style.display = "block";
            return;
        }

        listaClientes.forEach(cliente => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cliente.id || ''}</td>
                <td>${cliente.nombre || ''}</td>
                <td>${cliente.correo || ''}</td>
                <td>${cliente.celular || ''}</td>
                <td>${cliente.numeroCuenta || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${cliente.id}">Editar</button>
                    <button class="btn-delete" data-id="${cliente.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Asegurarse de que la sección de resultados sea visible
        document.getElementById("resultados-clientes").style.display = "block";

        // Agregar eventos a los botones de edición y eliminación
        document.querySelectorAll('#clientes-table .btn-edit').forEach(btn => { // Usar ID de la tabla para más especificidad
            btn.addEventListener('click', () => editarCliente(btn.dataset.id));
        });

        document.querySelectorAll('#clientes-table .btn-delete').forEach(btn => { // Usar ID de la tabla para más especificidad
            btn.addEventListener('click', () => eliminarCliente(btn.dataset.id));
        });
    }

    // Nueva función para buscar clientes directamente a la API
    async function buscarClientesPorAPI() {
        const termino = document.getElementById('search-cliente').value.trim();

        if (!termino) {
            // Si el término de búsqueda está vacío, cargamos todos los clientes
            // O puedes decidir renderizar la tabla vacía con un mensaje
            return cargarTodosLosClientes();
        }

        try {
            // Necesitas un endpoint en tu API de Spring Boot que maneje la búsqueda por término.
            // Por ejemplo: GET /api/admin/clientes/search?query=<valor>
            const response = await fetch(`http://localhost:8080/api/admin/clientes/search?query=${encodeURIComponent(termino)}`);
            if (!response.ok) throw new Error("Error al buscar clientes en la API");

            clientes = await response.json(); // Actualiza la lista global con los resultados de la búsqueda
            renderizarClientes(clientes); // Renderiza los resultados de la búsqueda
        } catch (error) {
            console.error("Error en la búsqueda de clientes:", error);
            alert("Error al buscar clientes: " + error.message);
            renderizarClientes([]); // En caso de error, muestra la tabla vacía
        }
    }


    async function editarCliente(id) {
        // Asegúrate de que 'id' se está pasando correctamente y que 'clientes' está poblado
        const cliente = clientes.find(c => c.id == id); // Usar == en lugar de === si los tipos pueden variar (string vs number)
        if (!cliente) {
            alert('Cliente no encontrado en la lista actual. Intente recargar los datos.');
            return;
        }

        const form = document.getElementById('cliente-form');
        form.id.value = cliente.id || '';
        form.nombre.value = cliente.nombre || '';
        form.correo.value = cliente.correo || '';
        form.celular.value = cliente.celular || '';
        form.numeroCuenta.value = cliente.numeroCuenta || '';
        form.direccion.value = cliente.direccion || '';

        modoEdicionCliente = true;
        clienteEditando = cliente;

        // Cambiar el texto del botón
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Cliente';
    }

    async function eliminarCliente(id) {
        if (!confirm('¿Está seguro de eliminar este cliente?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/admin/clientes/${id}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error("Error al eliminar cliente");

            alert("Cliente eliminado correctamente");
            // Después de eliminar, re-ejecutar la última búsqueda o cargar todos
            const terminoActual = document.getElementById('search-cliente').value.trim();
            buscarClientesPorAPI(); // Para refrescar la tabla con el estado actual
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar cliente: " + error.message);
        }
    }

    async function manejarCliente(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        // Si es una creación, el ID no debe ser enviado en el cuerpo si es autoincremental/generado por backend
        if (!modoEdicionCliente) {
            delete data.id; // Eliminar el campo 'id' para la creación
        } else {
             // Si es edición, asegúrate de que el ID en `data` sea el correcto (del clienteEditando)
             data.id = clienteEditando.id;
        }


        try {
            let response;
            const url = modoEdicionCliente
                ? `http://localhost:8080/api/admin/clientes/${clienteEditando.id}`
                : "http://localhost:8080/api/admin/clientes";

            const method = modoEdicionCliente ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error("Error al guardar cliente: " + errorText);
            }

            alert(`Cliente ${modoEdicionCliente ? 'actualizado' : 'creado'} correctamente`);
            limpiarFormularioCliente(); // Limpia el formulario después de guardar/actualizar
            // Después de guardar/actualizar, re-ejecutar la última búsqueda o cargar todos
            buscarClientesPorAPI(); // Para refrescar la tabla con el estado actual
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar cliente: " + error.message);
        }
    }

    // Nueva función para limpiar el formulario de cliente
    function limpiarFormularioCliente() {
        const form = document.getElementById('cliente-form');
        form.reset();
        modoEdicionCliente = false;
        clienteEditando = null;
        form.querySelector('button[type="submit"]').textContent = 'Guardar Cliente';
        // Si el campo ID no es generado por el backend, asegúrate de que esté vacío
        // form.id.value = ''; // Si no es autoincremental y lo reseteas
    }


    // ==================== FUNCIONES PARA EMPLEADOS ====================

    // Asumiendo que quieres el mismo comportamiento para empleados:
    // La tabla vacía hasta que se busca, y el formulario limpio.

    async function cargarTodosLosEmpleados() {
        try {
            const response = await fetch("http://localhost:8080/api/admin/empleados");
            if (!response.ok) throw new Error("Error al cargar todos los empleados");

            empleados = await response.json();
            renderizarEmpleados(empleados);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar empleados: " + error.message);
        }
    }

    function renderizarEmpleados(listaEmpleados) {
        const tbody = document.querySelector('#empleados-table tbody');
        tbody.innerHTML = '';

        if (listaEmpleados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No se encontraron empleados. Realice una búsqueda.</td></tr>';
            document.getElementById("resultados-empleados").style.display = "block";
            return;
        }

        listaEmpleados.forEach(empleado => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${empleado.cedula || ''}</td>
                <td>${empleado.nombre || ''}</td>
                <td>${empleado.usuario || ''}</td>
                <td>${empleado.areaEncargada || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${empleado.cedula}">Editar</button>
                    <button class="btn-delete" data-id="${empleado.cedula}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("resultados-empleados").style.display = "block";

        document.querySelectorAll('#empleados-table .btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editarEmpleado(btn.dataset.id));
        });

        document.querySelectorAll('#empleados-table .btn-delete').forEach(btn => {
            btn.addEventListener('click', () => eliminarEmpleado(btn.dataset.id));
        });
    }

    async function buscarEmpleadosPorAPI() { // Renombrada para claridad
        const filtro = document.getElementById('search-empleado').value.trim();

        if (!filtro) {
            return cargarTodosLosEmpleados();
        }

        try {
            // Necesitas un endpoint en tu API de Spring Boot para buscar empleados
            const response = await fetch(`http://localhost:8080/api/admin/empleados/search?query=${encodeURIComponent(filtro)}`);
            if (!response.ok) throw new Error("Error al buscar empleados en la API");

            empleados = await response.json(); // Actualiza la lista global
            renderizarEmpleados(empleados);
        } catch (error) {
            console.error("Error en la búsqueda de empleados:", error);
            alert("Error al buscar empleados: " + error.message);
            renderizarEmpleados([]); // En caso de error
        }
    }


    async function editarEmpleado(cedula) {
        const empleado = empleados.find(e => e.cedula == cedula);
        if (!empleado) {
             alert('Empleado no encontrado en la lista actual. Intente recargar los datos.');
             return;
        }

        const form = document.getElementById('empleado-form');
        form.cedula.value = empleado.cedula || '';
        form.usuario.value = empleado.usuario || '';
        form.nombre.value = empleado.nombre || '';
        form.areaEncargada.value = empleado.areaEncargada || '';
        form.contrasena.placeholder = "Dejar en blanco para no cambiar"; // Mantener este placeholder

        modoEdicionEmpleado = true;
        empleadoEditando = empleado;

        // Cambiar el texto del botón
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Empleado';
    }

    async function eliminarEmpleado(cedula) {
        if (!confirm('¿Está seguro de eliminar este empleado?')) return;

        try {
            const response = await fetch(`http://localhost:8080/api/admin/empleados/${cedula}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error("Error al eliminar empleado");

            alert("Empleado eliminado correctamente");
            buscarEmpleadosPorAPI(); // Refrescar la tabla
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar empleado: " + error.message);
        }
    }

    async function manejarEmpleado(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        // Si es creación, la cédula puede ser un ID generado por el backend,
        // si no, asegúrate de que `data.cedula` sea la correcta.
        // Si la contraseña está vacía y es un PUT, no la envíes para no sobreescribir.
        if (modoEdicionEmpleado && data.contrasena === "") {
            delete data.contrasena;
        }


        try {
            let response;
            const url = modoEdicionEmpleado
                ? `http://localhost:8080/api/admin/empleados/${empleadoEditando.cedula}`
                : "http://localhost:8080/api/admin/empleados";

            const method = modoEdicionEmpleado ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error al guardar empleado: ${errorText}`);
            }

            alert(`Empleado ${modoEdicionEmpleado ? 'actualizado' : 'creado'} correctamente`);
            limpiarFormularioEmpleado();
            buscarEmpleadosPorAPI(); // Refrescar la tabla
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar empleado: " + error.message);
        }
    }

    function limpiarFormularioEmpleado() {
        const form = document.getElementById('empleado-form');
        form.reset();
        modoEdicionEmpleado = false;
        empleadoEditando = null;
        form.querySelector('button[type="submit"]').textContent = 'Guardar Empleado';
        form.contrasena.placeholder = ""; // Limpiar placeholder si lo habías puesto
    }


    // ==================== FUNCIONES PARA DISPOSITIVOS ====================
    // Variables de estado para dispositivos (asegúrate de que no se redeclaren en otros lugares)
    let modoEdicionDispositivo = false;
    let dispositivoEditando = null;

    function abrirMapaParaSeleccionar() {
        const form = document.getElementById('dispositivo-form');
        const formData = {
            nombre: form.nombre.value,
            tipo: form.tipo.value,
            estado: form.estado.value,
            ubicacion: form.ubicacion.value,
            coordenadas: form.coordenadas.value
        };

        sessionStorage.setItem("formularioDispositivo", JSON.stringify(formData));
        window.open("mapa", "_blank");
    }

    // Escuchar mensajes del mapa
    window.addEventListener('message', function(event) {
        if (event.data.type === 'ubicacionSeleccionada') {
            const form = document.getElementById('dispositivo-form');
            form.ubicacion.value = event.data.direccion;
            form.coordenadas.value = event.data.coordenadas;
        }
    });

    async function buscarDispositivos(termino = '') {
        try {
            let url = "http://localhost:8081/api/dispositivos";
            const terminoValido = termino && termino.trim().length > 0;

            if (terminoValido) {
                url += `/search?query=${encodeURIComponent(termino.trim())}`; // Asumiendo un endpoint de búsqueda
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error("Error al buscar dispositivos");

            const dispositivos = await response.json();
            const resultadosDiv = document.getElementById('resultados-dispositivos');
            resultadosDiv.style.display = 'block'; // Siempre mostrar la tabla después de buscar

            renderizarDispositivos(dispositivos);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar dispositivos: " + error.message);
            renderizarDispositivos([]); // Renderizar vacío en caso de error
        }
    }


    function renderizarDispositivos(listaDispositivos) {
        const tbody = document.getElementById('dispositivos-body');
        tbody.innerHTML = '';
        if (listaDispositivos.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" class="no-results">No se encontraron dispositivos</td>`;
            tbody.appendChild(tr);
            return;
        }

        listaDispositivos.forEach(dispositivo => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dispositivo.id || ''}</td>
                <td>${dispositivo.nombre || ''}</td>
                <td>${dispositivo.tipo || ''}</td>
                <td>${dispositivo.ubicacion || ''}</td>
                <td>${dispositivo.estado || ''}</td>
                <td class="actions">
                    <button class="btn-alerts" data-id="${dispositivo.id}">Ver Alertas</button>
                    <button class="btn-edit" data-id="${dispositivo.id}">Editar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Agregar eventos a los botones
        document.querySelectorAll('#dispositivos-body .btn-alerts').forEach(btn => {
            btn.addEventListener('click', () => {
                const dispositivoId = btn.dataset.id;
                cargarAlertasDispositivo(dispositivoId);
                // Si quieres cambiar a la pestaña de Alertas automáticamente, usa:
                // document.querySelector('.menu li:nth-child(3)').click(); // Asumiendo que Alertas es la 3ra opción
                // Y asegúrate de que el ID del dispositivo se maneje en la pestaña de alertas
            });
        });

        document.querySelectorAll('#dispositivos-body .btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editarDispositivo(btn.dataset.id));
        });
    }

    async function editarDispositivo(id) {
        try {
            const response = await fetch(`http://localhost:8081/api/dispositivos/${id}`);
            if (!response.ok) throw new Error("Error al cargar dispositivo");

            const dispositivo = await response.json();
            const form = document.getElementById('dispositivo-form');

            form.nombre.value = dispositivo.nombre || '';
            form.tipo.value = dispositivo.tipo || '';
            form.estado.value = dispositivo.estado || '';
            form.ubicacion.value = dispositivo.ubicacion || '';
            form.coordenadas.value = dispositivo.coordenadas || '';

            modoEdicionDispositivo = true; // Actualiza el estado de edición
            dispositivoEditando = dispositivo; // Guarda el objeto completo

            form.querySelector('button[type="submit"]').textContent = 'Actualizar Dispositivo';
            // form.dataset.editando = id; // Esto se maneja mejor con la variable dispositivoEditando
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar dispositivo: " + error.message);
        }
    }

    async function manejarDispositivo(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            nombre: form.nombre.value,
            tipo: form.tipo.value,
            estado: form.estado.value,
            ubicacion: form.ubicacion.value,
            coordenadas: form.coordenadas.value
        };

        if (!data.coordenadas) {
            alert("Por favor seleccione una ubicación en el mapa");
            return;
        }

        try {
            let response;
            const url = modoEdicionDispositivo
                ? `http://localhost:8081/api/dispositivos/${dispositivoEditando.id}` // Usar el ID del objeto editando
                : "http://localhost:8081/api/dispositivos";

            const method = modoEdicionDispositivo ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error("Error al guardar dispositivo: " + errorText);
            }

            alert(`Dispositivo ${modoEdicionDispositivo ? 'actualizado' : 'creado'} correctamente`);
            limpiarFormularioDispositivo(); // Limpia y resetea el modo
            buscarDispositivos(); // Refrescar la tabla con la última búsqueda
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar dispositivo: " + error.message);
        }
    }

    function limpiarFormularioDispositivo() {
        const form = document.getElementById('dispositivo-form');
        form.reset();
        modoEdicionDispositivo = false;
        dispositivoEditando = null;
        form.querySelector('button[type="submit"]').textContent = 'Guardar Dispositivo';
    }


    // ==================== FUNCIONES PARA ALERTAS ====================
    let alertas = []; // Declarar globalmente para que todas las funciones la compartan

    async function cargarTodasLasAlertas() {
        try {
            const response = await fetch("http://localhost:8082/api/alertas");
            if (!response.ok) throw new Error("Error al cargar alertas");

            alertas = await response.json();
            renderizarAlertas(alertas);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar alertas: " + error.message);
        }
    }

    async function cargarAlertasDispositivo(dispositivoId) {
        try {
            const response = await fetch(`http://localhost:8082/api/alertas/dispositivo/${dispositivoId}`);
            if (!response.ok) throw new Error("Error al cargar alertas del dispositivo");

            alertas = await response.json();
            renderizarAlertas(alertas);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar alertas del dispositivo: " + error.message);
        }
    }

    function renderizarAlertas(listaAlertas) {
        const tbody = document.getElementById('alertas-body');
        tbody.innerHTML = '';

        if (listaAlertas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No se encontraron alertas.</td></tr>';
            return;
        }

        listaAlertas.forEach(alerta => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${alerta.id || ''}</td>
                <td>${alerta.idDispositivo || ''}</td>
                <td>${alerta.tipoAlerta || ''}</td>
                <td>${alerta.descripcion || ''}</td>
                <td>${alerta.nivelSeveridad || ''}</td>
                <td>${alerta.fechaHora ? new Date(alerta.fechaHora).toLocaleString() : ''}</td>
                <td>${alerta.estado || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${alerta.id}">Editar</button>
                    <button class="btn-delete" data-id="${alerta.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('#alertas-body .btn-edit').forEach(btn => { // Especificar el tbody
            btn.addEventListener('click', () => editarAlerta(btn.dataset.id));
        });

        document.querySelectorAll('#alertas-body .btn-delete').forEach(btn => { // Especificar el tbody
            btn.addEventListener('click', () => eliminarAlerta(btn.dataset.id));
        });
    }

    async function editarAlerta(id) {
        const alerta = alertas.find(a => a.id == id);
        if (!alerta) {
            alert('Alerta no encontrada en la lista actual. Intente recargar los datos.');
            return;
        }

        const form = document.getElementById('alerta-form');
        // Asegúrate de que los 'name' de tus inputs en el HTML coincidan con los nombres en el objeto 'alerta'
        form.dispositivo.value = alerta.idDispositivo || ''; // Tu HTML tiene 'dispositivo' para el input
        form.tipo.value = alerta.tipoAlerta || '';          // Tu HTML tiene 'tipo' para el input
        form.descripcion.value = alerta.descripcion || '';
        form.severidad.value = alerta.nivelSeveridad || ''; // Tu HTML tiene 'severidad' para el input
        // form.estado.value = alerta.estado || ''; // No hay campo 'estado' en tu formulario HTML para alertas

        modoEdicionAlerta = true;
        alertaEditando = alerta;

        // Cambiar el texto del botón
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Alerta';
    }

    async function eliminarAlerta(id) {
        if (!confirm('¿Está seguro de eliminar esta alerta?')) return;

        try {
            const response = await fetch(`http://localhost:8082/api/alertas/${id}`, {
                method: "DELETE"
            });

            if (!response.ok) throw new Error("Error al eliminar alerta");

            alert("Alerta eliminada correctamente");
            cargarTodasLasAlertas();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar alerta: " + error.message);
        }
    }

    async function manejarAlerta(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        // Renombrar campos para que coincidan con tu backend de Alerta (si es necesario)
        const payload = {
            idDispositivo: data.dispositivo,
            tipoAlerta: data.tipo,
            descripcion: data.descripcion,
            nivelSeveridad: data.severidad
            // Otros campos como fechaHora, estado, etc., podrían ser manejados por el backend
        };


        if (!payload.idDispositivo.match(/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/)) {
            alert("El ID del dispositivo debe ser un UUID válido (ej: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)");
            return;
        }

        try {
            let response;
            const url = modoEdicionAlerta
                ? `http://localhost:8082/api/alertas/${alertaEditando.id}`
                : "http://localhost:8082/api/alertas";

            const method = modoEdicionAlerta ? "PUT" : "POST";

            response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload) // Usar el payload transformado
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error al guardar alerta: ${errorText}`);
            }

            alert(`Alerta ${modoEdicionAlerta ? 'actualizada' : 'creada'} correctamente`);
            limpiarFormularioAlerta();
            cargarTodasLasAlertas(); // Recargar todas las alertas después de guardar
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar alerta: " + error.message);
        }
    }

    function limpiarFormularioAlerta() {
        const form = document.getElementById('alerta-form');
        form.reset();
        modoEdicionAlerta = false;
        alertaEditando = null;
        form.querySelector('button[type="submit"]').textContent = 'Guardar Alerta';
    }


    function filtrarAlertas() {
        const severidad = document.getElementById('alert-filter').value; // Tu HTML tiene alert-filter
        // const estado = document.getElementById('filtro-estado').value; // No hay un filtro de estado en tu HTML

        const filas = document.querySelectorAll('#alertas-body tr');

        filas.forEach(fila => {
            const textoSeveridad = fila.cells[4].textContent; // Columna de Severidad
            // const textoEstado = fila.cells[6].textContent; // Columna de Estado

            const coincideSeveridad = (severidad === 'all' || textoSeveridad === severidad);
            // const coincideEstado = (!estado || textoEstado === estado);

            fila.style.display = (coincideSeveridad) ? '' : 'none'; // Solo filtrar por severidad
        });
    }


    // ==================== FUNCIONES DE SESIÓN ====================

    function cerrarSesion() {
        window.location.href = "/";
    }
</script>
</body>
</html>