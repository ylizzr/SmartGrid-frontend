<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Operadores</title>
    <link rel="stylesheet" href="css/portal-operador.css">
</head>
<body>
<header>
    <div class="container">
        <div class="logo">
            <img src="/img/logo.png" alt="Energía Inteligente">
        </div>
        <button onclick="cerrarSesion()">CERRAR SESIÓN</button>
    </div>
</header>

<section class="welcome-section">
    <div class="container">
        <h2>Bienvenido(a) al Portal de Operadores</h2>
    </div>
</section>

<section>
    <div class="container">
        <div class="menu">
            <ul>
                <li class="active" data-target="">Menu</li>
                <li data-target="incidencias">Incidencias</li>
                <li data-target="alertas">Alertas</li>
                <li data-target="mapa">Mapa</li>
                <li data-target="facturas">Facturación</li>
                <li data-target="clientes">Clientes</li>
                <li data-target="empleados">Empleados</li>
            </ul>
        </div>

        <div class="content-area">
            <div class="empty-message">Seleccione una opción del menú</div>

            <!-----INCIDENCIAS----->
            <div class="content" id="incidencias">
                <h2>Gestión de Incidencias</h2>
                <form id="incidencia-form">
                    <label>ID:</label>
                    <input type="text" class="form-control" placeholder="ID de la incidencia">
                    <label>Tipo:</label>
                    <select class="form-control">
                        <option>Técnica</option>
                        <option>Comercial</option>
                        <option>Seguridad</option>
                    </select>
                    <label>Descripción:</label>
                    <textarea class="form-control" rows="3"></textarea>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>

            <!-----ALERTAS------>
            <div class="content" id="alertas">
                <h2>Gestión de Alertas</h2>
                <div class="form-container">
                    <form id="alerta-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Dispositivo:</label>
                                <select name="dispositivo" id="select-dispositivo" class="form-control" required>
                                    <option value="">Seleccione un dispositivo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo:</label>
                                <select name="tipo" class="form-control" required>
                                    <option value="">Seleccione tipo</option>
                                    <option value="Emergencia">Emergencia</option>
                                    <option value="Advertencia">Advertencia</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Severidad:</label>
                                <select name="severidad" class="form-control" required>
                                    <option value="Alta">Alta</option>
                                    <option value="Media">Media</option>
                                    <option value="Baja">Baja</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Descripción:</label>
                                <textarea name="descripcion" class="form-control" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Alerta</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3>Alertas Recientes</h3>
                    <div class="filter-bar">
                        <select id="alert-filter" class="filter-select">
                            <option value="all">Todas</option>
                            <option value="high">Alta Severidad</option>
                            <option value="medium">Media Severidad</option>
                            <option value="low">Baja Severidad</option>
                        </select>
                        <button onclick="filtrarAlertas()">Filtrar</button>
                    </div>
                    <table id="alertas-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Dispositivo</th>
                            <th>Tipo</th>
                            <th>Descripción</th>
                            <th>Severidad</th>
                            <th>Fecha</th>
                        </tr>
                        </thead>
                        <tbody id="alertas-body">
                        </tbody>
                    </table>
                </div>
            </div>


            <!----MAPA Y DISPOSITIVOS----->
            <div class="content" id="mapa">
                <h2>Gestión de Dispositivos</h2>
                <div class="form-container">
                    <form id="dispositivo-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Tipo:</label>
                                <select name="tipo" class="form-control" required>
                                    <option value="Sensor">Sensor</option>
                                    <option value="Medidor">Medidor</option>
                                    <option value="Controlador">Controlador</option>
                                    <option value="Panel">Panel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Estado:</label>
                                <select name="estado" class="form-control" required>
                                    <option value="Activo">Activo</option>
                                    <option value="Inactivo">Inactivo</option>
                                    <option value="Mantenimiento">Mantenimiento</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Ubicación:</label>
                                <input type="text" name="ubicacion" id="ubicacion-input" class="form-control" required readonly>
                                <input type="hidden" name="coordenadas" id="coordenadas-input">
                                <small class="text-muted">Haz clic en "Seleccionar en Mapa" para elegir la ubicación</small>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="abrirMapaParaSeleccionar()">Seleccionar en Mapa</button>
                            <button type="submit" class="btn btn-primary">Guardar Dispositivo</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <input type="text" id="buscar-dispositivo" class="search-input" placeholder="Buscar dispositivos...">
                    <button id="btn-buscar-dispositivo" class="btn btn-primary">Buscar</button>
                    <button id="btn-mostrar-todos" class="btn btn-secondary">Mostrar Todos</button>
                </div>

                <div id="resultados-dispositivos" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="dispositivos-body"></tbody>
                    </table>
                </div>
            </div>

            <!------FACTURACION----->
            <div class="content" id="facturas">
                <h2>Gestión de Facturas</h2>
                <div class="form-container">
                    <form id="factura-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ID Cliente:</label>
                                <select name="idCliente" id="select-clientes" required></select>
                            </div>
                            <div class="form-group">
                                <label>Consumo Total (kWh):</label>
                                <input type="number" step="0.01" name="consumoTotal" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="display: none;">
                                <label>Costo Total ($):</label>
                                <input type="number" step="0.01" name="costoTotal" id="costoTotal" readonly>
                            </div>
                            <div class="form-group">
                                <label>Periodo Facturado (YYYY-MM):</label>
                                <input type="month" name="periodoFacturado" id="periodoFacturado" required>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Factura</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <button id="search-btn-facturas" class="btn btn-secondary">Mostrar Todas</button>
                </div>

                <div id="resultados-facturas" style="display: none; margin-top: 20px;">
                    <h3>Facturas Generadas</h3>
                    <table id="facturas-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Fecha emisión</th>
                            <th>Consumo</th>
                            <th>Costo</th>
                            <th>Periodo</th>
                            <th>Pago</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!------CLIENTES------>
            <div class="content" id="clientes">
                <h2>Gestión de Clientes</h2>
                <div class="form-container">
                    <form id="cliente-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Número de identificación:</label>
                                <input type="text" name="id" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Correo:</label>
                                <input type="email" name="correo" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Teléfono:</label>
                                <input type="tel" name="celular" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Número de cuenta:</label>
                                <input type="text" name="numeroCuenta" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Dirección:</label>
                                <input type="text" name="direccion" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>


                <div class="search-container">
                    <input type="text" id="search-cliente" class="search-input" placeholder="Buscar clientes...">
                    <button id="btn-search-cliente" class="btn btn-primary">Buscar</button>
                </div>
                <div id="resultados-clientes" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>
                    <table id="clientes-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Número de identificación</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Teléfono</th>
                            <th>Cuenta</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>


            <!-----EMPLEADOS----->
            <div class="content" id="empleados">
                <h2>Gestión de Empleados</h2>
                <div class="form-container">
                    <form id="empleado-form" class="compact-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Cédula:</label>
                                <input type="text" name="cedula" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" name="usuario" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contraseña:</label>
                                <input type="password" name="contrasena" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="nombre" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Cargo:</label>
                                <input type="text" name="areaEncargada" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Guardar Empleado</button>
                            <button type="reset" class="btn btn-secondary">Limpiar</button>
                        </div>
                    </form>
                </div>

                <div class="search-container">
                    <input type="text" id="search-empleado" class="search-input" placeholder="Buscar empleados...">
                    <button id="btn-search-empleado" class="btn btn-primary">Buscar</button>
                    <button id="search-btn-empleados" class="btn btn-secondary">Mostrar Todos</button>
                </div>
                <div id="resultados-empleados" style="display: none; margin-top: 20px;">
                    <h3>Resultados de la Búsqueda</h3>

                    <table id="empleados-table" class="data-table">
                        <thead>
                        <tr>
                            <th>Cédula</th>
                            <th>Nombre</th>
                            <th>Usuario</th>
                            <th>Cargo</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>&copy; 2025 Energía Inteligente</p>
    </div>
</footer>
<script>
    // ==================== VARIABLES GLOBALES ====================
    let clientes = [];
    let empleados = [];
    let modoEdicionCliente = false;
    let clienteEditando = null;
    let modoEdicionEmpleado = false;
    let empleadoEditando = null;

    document.addEventListener('DOMContentLoaded', function () {
        // Menú y secciones
        const menuItems = document.querySelectorAll('.menu ul li');
        const contents = document.querySelectorAll('.content');
        const emptyMessage = document.querySelector('.empty-message');

        menuItems.forEach(item => {
            item.addEventListener('click', function () {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                contents.forEach(c => c.classList.remove('active'));

                const contentId = this.dataset.target;
                if (!contentId) {
                    emptyMessage.style.display = 'block';
                } else {
                    emptyMessage.style.display = 'none';
                    const target = document.getElementById(contentId);
                    if (target) target.classList.add('active');

                    //if (contentId === 'clientes') cargarClientes();
                    //if (contentId === 'empleados') cargarEmpleados();
                    if (contentId === 'alertas') activarVistaAlertas();


                }
            });
        });

        // Eventos - Clientes
        document.getElementById('cliente-form').addEventListener('submit', manejarCliente);
        document.getElementById('btn-search-cliente').addEventListener('click', () => {
            const filtro = document.getElementById('search-cliente').value.trim();
            buscarClientes(filtro);
        });
        document.getElementById('search-btn').addEventListener('click', cargarClientes);


    });

    // ==================== CLIENTES ====================
    async function cargarClientes() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8080/api/admin/clientes");
            if (!response.ok) throw new Error("Error al cargar clientes");
            const data = await response.json();
            clientes = data;
            renderizarClientes(data);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar clientes: " + error.message);
        }
    }

    async function buscarClientes(filtro) {
        if (!filtro) return alert("Ingresa un valor para buscar");

        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8080/api/admin/clientes/buscar?filtro=${encodeURIComponent(filtro)}`);
            if (!response.ok) throw new Error("Error al buscar clientes");

            const resultados = await response.json();
            if (resultados.length > 0) {
                renderizarClientes(resultados);
            } else {
                alert("No se encontraron clientes");
                document.getElementById('clientes-table').querySelector('tbody').innerHTML = '';
                document.getElementById("resultados-clientes").style.display = "none";
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar clientes: " + error.message);
        }
    }

    function renderizarClientes(lista) {
        const tbody = document.getElementById('clientes-table').querySelector('tbody');
        tbody.innerHTML = '';
        lista.forEach(cliente => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${cliente.id || ''}</td>
                <td>${cliente.nombre || ''}</td>
                <td>${cliente.correo || ''}</td>
                <td>${cliente.celular || ''}</td>
                <td>${cliente.numeroCuenta || ''}</td>
                <td>
                    <button class="btn-edit" data-id="${cliente.id}">Editar</button>
                    <button class="btn-delete" data-id="${cliente.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("resultados-clientes").style.display = "block";

        document.querySelectorAll('.btn-edit').forEach(btn =>
            btn.addEventListener('click', () => editarCliente(btn.dataset.id))
        );
        document.querySelectorAll('.btn-delete').forEach(btn =>
            btn.addEventListener('click', () => eliminarCliente(btn.dataset.id))
        );
    }

    function editarCliente(id) {
        const cliente = clientes.find(c => c.id == id);
        if (!cliente) return;

        const form = document.getElementById('cliente-form');
        form.id.value = cliente.id || '';
        form.nombre.value = cliente.nombre || '';
        form.correo.value = cliente.correo || '';
        form.celular.value = cliente.celular || '';
        form.numeroCuenta.value = cliente.numeroCuenta || '';
        form.direccion.value = cliente.direccion || '';

        modoEdicionCliente = true;
        clienteEditando = cliente;

        form.querySelector('button[type="submit"]').textContent = 'Actualizar Cliente';
    }

    async function eliminarCliente(id) {
        if (!confirm('¿Está seguro de eliminar este cliente?')) return;
        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8080/api/admin/clientes/${id}`, {
                method: "DELETE"
            });
            if (!response.ok) throw new Error("Error al eliminar cliente");

            alert("Cliente eliminado correctamente");
            cargarClientes();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar cliente: " + error.message);
        }
    }

    async function manejarCliente(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        if (modoEdicionCliente) data.id = clienteEditando.id;

        try {
            const url = modoEdicionCliente
                ? `http://energiainteligente.ddns.net:8080/api/admin/clientes/${clienteEditando.id}`
                : "http://energiainteligente.ddns.net:8080/api/admin/clientes";
            const method = modoEdicionCliente ? "PUT" : "POST";

            const response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar cliente");

            alert(`Cliente ${modoEdicionCliente ? 'actualizado' : 'creado'} correctamente`);
            form.reset();
            modoEdicionCliente = false;
            clienteEditando = null;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Cliente';
            cargarClientes();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar cliente: " + error.message);
        }
    }

    // ==================== EMPLEADOS ====================
    async function cargarEmpleados() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8080/api/admin/empleados");
            if (!response.ok) throw new Error("Error al cargar empleados");
            empleados = await response.json();
            renderizarEmpleados(empleados);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar empleados: " + error.message);
        }
    }

    async function buscarEmpleados(filtro) {
        if (!filtro) return alert("Ingresa un valor para buscar");

        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8080/api/admin/empleados/buscar?filtro=${encodeURIComponent(filtro)}`);
            if (!response.ok) throw new Error("Error al buscar empleados");

            const resultados = await response.json();
            if (resultados.length > 0) {
                renderizarEmpleados(resultados);
            } else {
                alert("No se encontraron empleados");
                document.querySelector('#empleados-table tbody').innerHTML = '';
                document.getElementById("resultados-empleados").style.display = "none";
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar empleados: " + error.message);
        }
    }

    function renderizarEmpleados(lista) {
        const tbody = document.querySelector('#empleados-table tbody');
        tbody.innerHTML = '';
        lista.forEach(empleado => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${empleado.cedula || ''}</td>
                <td>${empleado.nombre || ''}</td>
                <td>${empleado.usuario || ''}</td>
                <td>${empleado.areaEncargada || ''}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${empleado.cedula}">Editar</button>
                    <button class="btn-delete" data-id="${empleado.cedula}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("resultados-empleados").style.display = "block";

        document.querySelectorAll('.btn-edit').forEach(btn =>
            btn.addEventListener('click', () => editarEmpleado(btn.dataset.id))
        );
        document.querySelectorAll('.btn-delete').forEach(btn =>
            btn.addEventListener('click', () => eliminarEmpleado(btn.dataset.id))
        );
    }

    function editarEmpleado(cedula) {
        const empleado = empleados.find(e => e.cedula === cedula);
        if (!empleado) return;

        const form = document.getElementById('empleado-form');
        form.cedula.value = empleado.cedula || '';
        form.usuario.value = empleado.usuario || '';
        form.nombre.value = empleado.nombre || '';
        form.areaEncargada.value = empleado.areaEncargada || '';
        form.contrasena.placeholder = "Dejar en blanco para no cambiar";

        modoEdicionEmpleado = true;
        empleadoEditando = empleado;

        form.querySelector('button[type="submit"]').textContent = 'Actualizar Empleado';
    }

    async function eliminarEmpleado(cedula) {
        if (!confirm('¿Está seguro de eliminar este empleado?')) return;

        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8080/api/admin/empleados/${cedula}`, {
                method: "DELETE"
            });
            if (!response.ok) throw new Error("Error al eliminar empleado");

            alert("Empleado eliminado correctamente");
            cargarEmpleados();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar empleado: " + error.message);
        }
    }

    async function manejarEmpleado(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        try {
            const url = modoEdicionEmpleado
                ? `http://energiainteligente.ddns.net:8080/api/admin/empleados/${empleadoEditando.cedula}`
                : "http://energiainteligente.ddns.net:8080/api/admin/empleados";
            const method = modoEdicionEmpleado ? "PUT" : "POST";

            const response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar empleado");

            alert(`Empleado ${modoEdicionEmpleado ? 'actualizado' : 'creado'} correctamente`);
            form.reset();
            modoEdicionEmpleado = false;
            empleadoEditando = null;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Empleado';
            cargarEmpleados();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar empleado: " + error.message);
        }
    }

    // Eventos - Empleados
    document.getElementById('empleado-form').addEventListener('submit', manejarEmpleado);
    document.getElementById('btn-search-empleado').addEventListener('click', () => {
        const filtro = document.getElementById('search-empleado').value.trim();
        buscarEmpleados(filtro);
        });
    document.getElementById('search-btn-empleados').addEventListener('click', cargarEmpleados);

    // ==================== VARIABLES GLOBALES ====================
    let alertas = [];
    let modoEdicionAlerta = false;
    let alertaEditando = null;

    // ==================== FUNCIONES PARA DISPOSITIVOS ====================

    function abrirMapaParaSeleccionar() {
        const form = document.getElementById('dispositivo-form');
        const formData = {
            nombre: form.nombre.value,
            tipo: form.tipo.value,
            estado: form.estado.value,
            ubicacion: form.ubicacion.value,
            coordenadas: form.coordenadas.value
        };

        sessionStorage.setItem("formularioDispositivo", JSON.stringify(formData));
        window.open("mapa", "_blank");
    }

    window.addEventListener('message', function (event) {
        if (event.data.type === 'ubicacionSeleccionada') {
            const form = document.getElementById('dispositivo-form');
            form.ubicacion.value = event.data.direccion;
            form.coordenadas.value = event.data.coordenadas;
        }
    });

    async function buscarDispositivos(termino = '') {
        try {
            let url = "http://energiainteligente.ddns.net:8081/api/dispositivos";
            if (termino.trim()) {
                url += `?search=${encodeURIComponent(termino.trim())}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error("Error al buscar dispositivos");

            const dispositivos = await response.json();
            document.getElementById('resultados-dispositivos').style.display = dispositivos.length ? 'block' : 'none';
            renderizarDispositivos(dispositivos);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al buscar dispositivos: " + error.message);
        }
    }

    function renderizarDispositivos(lista) {
        const tbody = document.getElementById('dispositivos-body');
        tbody.innerHTML = '';

        if (lista.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td colspan="6" class="no-results">No se encontraron dispositivos</td>`;
            tbody.appendChild(tr);
            return;
        }

        lista.forEach(dispositivo => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dispositivo.id || ''}</td>
                <td>${dispositivo.nombre || ''}</td>
                <td>${dispositivo.tipo || ''}</td>
                <td>${dispositivo.ubicacion || ''}</td>
                <td>${dispositivo.estado || ''}</td>
                <td class="actions">
                    <button class="btn-alerts" data-id="${dispositivo.id}">Ver Alertas</button>
                    <button class="btn-edit" data-id="${dispositivo.id}">Editar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.querySelectorAll('.btn-alerts').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.dataset.id;
                cargarAlertasDispositivo(id);
                document.querySelector('.menu [data-target="alertas"]').click();
            });
        });

        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => editarDispositivo(btn.dataset.id));
        });
    }

    async function editarDispositivo(id) {
        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8081/api/dispositivos/${id}`);
            if (!response.ok) throw new Error("Error al cargar dispositivo");

            const dispositivo = await response.json();
            const form = document.getElementById('dispositivo-form');

            form.nombre.value = dispositivo.nombre || '';
            form.tipo.value = dispositivo.tipo || '';
            form.estado.value = dispositivo.estado || '';
            form.ubicacion.value = dispositivo.ubicacion || '';
            form.coordenadas.value = dispositivo.coordenadas || '';

            form.querySelector('button[type="submit"]').textContent = 'Actualizar Dispositivo';
            form.dataset.editando = id;
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar dispositivo: " + error.message);
        }
    }

    async function manejarDispositivo(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
            nombre: form.nombre.value,
            tipo: form.tipo.value,
            estado: form.estado.value,
            ubicacion: form.ubicacion.value,
            coordenadas: form.coordenadas.value
        };

        if (!data.coordenadas.trim()) {
            alert("Por favor seleccione una ubicación en el mapa");
            return;
        }

        try {
            const url = form.dataset.editando
                ? `http://energiainteligente.ddns.net:8081/api/dispositivos/${form.dataset.editando}`
                : "http://energiainteligente.ddns.net:8081/api/dispositivos";

            const method = form.dataset.editando ? "PUT" : "POST";

            const response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar dispositivo");

            alert(`Dispositivo ${form.dataset.editando ? 'actualizado' : 'creado'} correctamente`);
            form.reset();
            delete form.dataset.editando;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Dispositivo';
            buscarDispositivos();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar dispositivo: " + error.message);
        }
    }

    document.getElementById('dispositivo-form').addEventListener('submit', manejarDispositivo);
    document.getElementById('btn-buscar-dispositivo').addEventListener('click', () => {
        const termino = document.getElementById('buscar-dispositivo').value.trim();
        buscarDispositivos(termino);
    });
    document.getElementById('btn-mostrar-todos').addEventListener('click', () => {
        document.getElementById('buscar-dispositivo').value = '';
        buscarDispositivos();
    });
    document.getElementById('buscar-dispositivo').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            const termino = e.target.value.trim();
            buscarDispositivos(termino);
        }
    });

    // ==================== FUNCIONES PARA ALERTAS ====================

    async function cargarTodasLasAlertas() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8862/api/alertas");
            if (!response.ok) throw new Error("Error al cargar alertas");

            alertas = await response.json();
            renderizarAlertas(alertas);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar alertas: " + error.message);
        }
    }


    async function cargarAlertasDispositivo(dispositivoId) {
        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8862/api/alertas/dispositivo/${dispositivoId}`);
            if (!response.ok) throw new Error("Error al cargar alertas del dispositivo");

            alertas = await response.json();
            renderizarAlertas(alertas);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar alertas del dispositivo: " + error.message);
        }
    }


    function renderizarAlertas(lista) {
        const tbody = document.getElementById('alertas-body');
        tbody.innerHTML = '';

        lista.forEach(alerta => {
            const dispositivo = dispositivos.find(d => d.id === alerta.idDispositivo);
            const nombreDispositivo = dispositivo ? dispositivo.nombre : alerta.idDispositivo;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${nombreDispositivo}</td>
                <td>${alerta.tipoAlerta || ''}</td>
                <td>${alerta.descripcion || ''}</td>
                <td>${alerta.nivelSeveridad || ''}</td>
                <td>${alerta.fechaHora ? new Date(alerta.fechaHora).toLocaleString() : ''}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Editar alerta (rellena formulario)
    async function editarAlerta(id) {
        const alerta = alertas.find(a => a.id == id);
        if (!alerta) return;

        const form = document.getElementById('alerta-form');
        form.dispositivo.value = alerta.idDispositivo || '';
        form.tipo.value = alerta.tipoAlerta || '';
        form.descripcion.value = alerta.descripcion || '';
        form.severidad.value = alerta.nivelSeveridad || '';

        modoEdicionAlerta = true;
        alertaEditando = alerta;
        form.querySelector('button[type="submit"]').textContent = 'Actualizar Alerta';
    }

    // Eliminar alerta
    async function eliminarAlerta(id) {
        if (!confirm('¿Está seguro de eliminar esta alerta?')) return;

        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8862/api/alertas/${id}`, {
                method: "DELETE"
            });
            if (!response.ok) throw new Error("Error al eliminar alerta");

            alert("Alerta eliminada correctamente");
            cargarTodasLasAlertas();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar alerta: " + error.message);
        }
    }


    async function manejarAlerta(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        if (!data.dispositivo.match(/^[0-9a-fA-F-]{36}$/)) {
            alert("Seleccione un dispositivo válido");
            return;
        }

        try {
            const url = modoEdicionAlerta
                ? `http://energiainteligente.ddns.net:8862/api/alertas/${alertaEditando.id}`
                : "http://energiainteligente.ddns.net:8862/api/alertas";

            const method = modoEdicionAlerta ? "PUT" : "POST";

            const response = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    idDispositivo: data.dispositivo,
                    tipoAlerta: data.tipo,
                    descripcion: data.descripcion,
                    nivelSeveridad: data.severidad
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error al guardar alerta: ${errorText}`);
            }

            alert(`Alerta ${modoEdicionAlerta ? 'actualizada' : 'creada'} correctamente`);
            form.reset();
            modoEdicionAlerta = false;
            alertaEditando = null;
            form.querySelector('button[type="submit"]').textContent = 'Guardar Alerta';
            cargarTodasLasAlertas();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar alerta: " + error.message);
        }

    }
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('alerta-form').addEventListener('submit', manejarAlerta);
    });



    function filtrarAlertas() {
        const severidad = document.getElementById('alert-filter').value.toLowerCase();
        const filas = document.querySelectorAll('#alertas-body tr');

        filas.forEach(fila => {
            const textoSeveridad = fila.cells[3].textContent.toLowerCase();
            const coincide = severidad === 'all' || textoSeveridad.includes(severidad);
            fila.style.display = coincide ? '' : 'none';
        });
    }

    async function cargarDispositivosEnFormulario() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8081/api/dispositivos");
            if (!response.ok) throw new Error("Error al cargar dispositivos");

            dispositivos = await response.json();

            const select = document.getElementById("select-dispositivo");
            if (!select) return;

            select.innerHTML = '<option value="">Seleccione un dispositivo</option>';

            dispositivos.forEach(dispositivo => {
                const option = document.createElement('option');
                option.value = dispositivo.id;
                option.textContent = dispositivo.nombre || dispositivo.id;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Error:", error);
            alert("No se pudieron cargar los dispositivos");
        }
    }



    async function activarVistaAlertas() {
        await cargarDispositivosEnFormulario();
        await cargarTodasLasAlertas();
    }

        // ==================== FACTURAS ====================
    let factura = [];
    let modoEdicionFactura = false;
    let facturaEditando = null;

    window.addEventListener('DOMContentLoaded', () => {
        cargarClientesEnSelect();
    });

    // ===================== CARGAR CLIENTES =====================
    async function cargarClientesEnSelect() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8080/api/admin/clientes");
            if (!response.ok) throw new Error("No se pudieron cargar los clientes");
            const clientes = await response.json();

            const select = document.getElementById("select-clientes");
            select.innerHTML = '<option value="">Seleccione un cliente</option>';

            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.text = `${cliente.nombre} (${cliente.numeroCuenta})`;
                select.appendChild(option);
            });

            // Activar Select2 (asegúrate que el script esté en tu HTML)
            $(select).select2({
                placeholder: "Buscar cliente...",
                allowClear: true,
                width: '100%'
            });

        } catch (error) {
            console.error("Error al cargar clientes:", error);
            alert("Error al cargar la lista de clientes");
        }
    }

    // ===================== CARGAR FACTURAS =====================
    async function cargarFacturas() {
        try {
            const response = await fetch("http://energiainteligente.ddns.net:8088/api/facturacion");
            if (!response.ok) throw new Error("Error al cargar facturas");
            const facturas = await response.json();
            renderizarFacturas(facturas);
        } catch (error) {
            console.error("Error:", error);
            alert("Error al cargar facturas: " + error.message);
        }
    }

    // ===================== RENDERIZAR =====================
    function renderizarFacturas(lista) {
        const tbody = document.querySelector('#facturas-table tbody');
        tbody.innerHTML = '';
        lista.forEach(factura => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${factura.idCliente}</td>
                <td>${factura.fechaEmision || '---'}</td>
                <td>${factura.consumoTotal} kWh</td>
                <td>$${factura.costoTotal}</td>
                <td>${factura.periodoFacturado}</td>
                <td>${factura.estadoPago || 'pendiente'}</td>
                <td class="actions">
                    <button class="btn-delete" data-id="${factura.id}">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById("resultados-facturas").style.display = "block";

        document.querySelectorAll('.btn-delete').forEach(btn =>
            btn.addEventListener('click', () => eliminarFactura(btn.dataset.id))
        );
    }

    // ===================== CREAR FACTURA =====================
    async function manejarFactura(e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));

        try {
            const response = await fetch("http://energiainteligente.ddns.net:8088/api/facturacion", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error("Error al guardar factura");
            alert("Factura creada correctamente");
            form.reset();
            $('#select-clientes').val('').trigger('change'); // Reinicia Select2
            cargarFacturas();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al guardar factura: " + error.message);
        }
    }

    // ===================== ELIMINAR =====================
    async function eliminarFactura(id) {
        if (!confirm("¿Deseas eliminar esta factura?")) return;
        try {
            const response = await fetch(`http://energiainteligente.ddns.net:8088/api/facturacion/${id}`, {
                method: "DELETE",
                credentials: "include"
            });

            if (!response.ok) throw new Error("No se pudo eliminar factura");
            alert("Factura eliminada correctamente");
            cargarFacturas();
        } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar factura: " + error.message);
        }
    }

    // ===================== CÁLCULO AUTOMÁTICO DE COSTO =====================
    document.querySelector('input[name="consumoTotal"]').addEventListener('input', e => {
        const consumo = parseFloat(e.target.value);
        const tarifa = 950; // Ajusta la tarifa aquí si cambia
        const costo = isNaN(consumo) ? 0 : consumo * tarifa;
        document.getElementById('costoTotal').value = costo.toFixed(2);
    });

    document.addEventListener("DOMContentLoaded", () => {
        const hoy = new Date();
        const año = hoy.getFullYear();
        const mes = String(hoy.getMonth() + 1).padStart(2, '0');
        document.getElementById("periodoFacturado").setAttribute("max", `${año}-${mes}`);
    });


    // ===================== EVENTOS =====================
    document.getElementById('factura-form').addEventListener('submit', manejarFactura);
    document.getElementById('search-btn-facturas').addEventListener('click', cargarFacturas);



// ==================== FUNCIONES DE SESIÓN ====================

    function cerrarSesion() {
        window.location.href = "/";
    }


</script>
</body>
</html>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
